// KGC ERP API - Unified Prisma Schema
// Combines all module schemas for the main application

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

/// User roles per ADR-032 RBAC Architecture
enum Role {
  OPERATOR      // Pultos / Értékesítő (Level 1)
  TECHNIKUS     // Szerviz technikus (Level 2)
  BOLTVEZETO    // Boltvezető (Level 3)
  ACCOUNTANT    // Könyvelő (Level 3)
  PARTNER_OWNER // Franchise Partner Tulajdonos (Level 4)
  CENTRAL_ADMIN // Központi Admin (Level 5)
  DEVOPS_ADMIN  // DevOps / IT Admin (Level 6)
  SUPER_ADMIN   // Rendszergazda (Level 8)
}

/// User account status
enum UserStatus {
  ACTIVE
  INACTIVE
  LOCKED
  PENDING_VERIFICATION
}

/// Tenant status
enum TenantStatus {
  PENDING    // Onboarding folyamatban
  ACTIVE     // Aktív tenant
  INACTIVE   // Soft deleted / inaktív
  SUSPENDED  // Felfüggesztett (fizetési probléma)
}

// ============================================
// TENANT MODELS
// ============================================

model Tenant {
  id              String       @id @default(uuid()) @db.Uuid
  name            String       @db.VarChar(255)
  slug            String       @unique @db.VarChar(100)
  status          TenantStatus @default(PENDING)
  settings        Json         @default("{}")

  // Holding struktúra (Story 3-6)
  parentTenantId  String?      @map("parent_tenant_id") @db.Uuid
  parentTenant    Tenant?      @relation("TenantHierarchy", fields: [parentTenantId], references: [id])
  childTenants    Tenant[]     @relation("TenantHierarchy")

  // Schema info
  schemaName      String?      @map("schema_name") @db.VarChar(100)
  schemaCreatedAt DateTime?    @map("schema_created_at")

  // Timestamps
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  deletedAt       DateTime?    @map("deleted_at")

  // Relations
  users           User[]
  locations       Location[]

  @@map("tenants")
  @@index([status])
  @@index([parentTenantId])
}

model TenantAuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  action    String   @db.VarChar(50)
  changes   Json     @default("{}")
  userId    String?  @map("user_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  @@map("tenant_audit_logs")
  @@index([tenantId])
  @@index([createdAt])
}

// ============================================
// LOCATION MODEL
// ============================================

model Location {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  name      String   @db.VarChar(255)
  address   String?  @db.VarChar(500)
  isActive  Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  users     User[]

  @@map("locations")
  @@index([tenantId])
}

// ============================================
// USER MODELS
// ============================================

model User {
  id           String     @id @default(uuid()) @db.Uuid
  email        String     @unique @db.VarChar(255)
  passwordHash String     @map("password_hash") @db.VarChar(255)
  name         String     @db.VarChar(255)
  role         Role       @default(OPERATOR)
  tenantId     String     @map("tenant_id") @db.Uuid
  locationId   String?    @map("location_id") @db.Uuid
  status       UserStatus @default(ACTIVE)
  pinHash      String?    @map("pin_hash") @db.VarChar(255)

  // Soft delete
  deletedAt    DateTime?  @map("deleted_at") @db.Timestamptz
  deletedEmail String?    @map("deleted_email") @db.VarChar(255)

  // Profile fields
  phone        String?    @db.VarChar(20)
  avatarUrl    String?    @map("avatar_url") @db.VarChar(500)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tenant              Tenant               @relation(fields: [tenantId], references: [id])
  location            Location?            @relation(fields: [locationId], references: [id])
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]

  @@index([email])
  @@index([tenantId])
  @@index([role])
  @@index([status])
  @@index([tenantId, locationId])
  @@map("users")
}

model RefreshToken {
  id         String   @id @default(uuid()) @db.Uuid
  token      String   @unique @db.VarChar(500)
  userId     String   @map("user_id") @db.Uuid
  expiresAt  DateTime @map("expires_at") @db.Timestamptz
  deviceInfo String?  @map("device_info") @db.VarChar(500)
  isRevoked  Boolean  @default(false) @map("is_revoked")
  revokedAt  DateTime? @map("revoked_at") @db.Timestamptz
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model LoginAttempt {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @db.VarChar(255)
  ipAddress String   @map("ip_address") @db.VarChar(45)
  success   Boolean  @default(false)
  userAgent String?  @map("user_agent") @db.VarChar(500)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([email, ipAddress, createdAt])
  @@index([ipAddress, createdAt])
  @@map("login_attempts")
}

model PasswordResetToken {
  id        String    @id @default(uuid()) @db.Uuid
  tokenHash String    @unique @map("token_hash") @db.VarChar(128)
  userId    String    @map("user_id") @db.Uuid
  expiresAt DateTime  @map("expires_at") @db.Timestamptz
  isUsed    Boolean   @default(false) @map("is_used")
  usedAt    DateTime? @map("used_at") @db.Timestamptz
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model TrustedDevice {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  locationId   String   @map("location_id") @db.Uuid
  deviceName   String   @map("device_name") @db.VarChar(255)
  status       String   @default("ACTIVE") @db.VarChar(20)
  lastUsedAt   DateTime? @map("last_used_at") @db.Timestamptz
  registeredAt DateTime @default(now()) @map("registered_at") @db.Timestamptz

  @@index([tenantId, locationId])
  @@index([status])
  @@map("trusted_devices")
}

model PinAttempt {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  deviceId      String    @map("device_id") @db.Uuid
  attemptCount  Int       @default(0) @map("attempt_count")
  lockedUntil   DateTime? @map("locked_until") @db.Timestamptz
  lastAttemptAt DateTime  @default(now()) @map("last_attempt_at") @db.Timestamptz
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([userId, deviceId])
  @@index([lockedUntil])
  @@map("pin_attempts")
}
