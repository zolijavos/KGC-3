// Real review data from BMAD Dual-AI Code Reviews
// Source: implementation-artifacts/reviews/

export interface ReviewIssue {
  id: string;
  title: string;
  description: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  reviewer: 'Claude' | 'Gemini' | 'Both';
  status: 'fixed' | 'open' | 'wontfix' | 'deferred';
  file: string;
  line?: number;
  category: string;
  autoFixed?: boolean;
}

export interface StoryReview {
  storyId: string;
  storyName: string;
  epicId: string;
  epicName: string;
  package: string;
  date: string;
  reviewer: string;
  round: number;
  maxRounds: number;
  issues: ReviewIssue[];
  consensusReached: boolean;
  verdict: 'approved' | 'approved-with-fixes' | 'rejected' | 'in-progress';
  testsPassed?: number;
  testsTotal?: number;
}

// Epic 1: Authentication (@kgc/auth)
export const EPIC_1_REVIEWS: StoryReview[] = [
  {
    storyId: '1-1',
    storyName: 'JWT Login Endpoint Implementation',
    epicId: '1',
    epicName: 'Authentication',
    package: '@kgc/auth',
    date: '2026-01-16',
    reviewer: 'Claude + Gemini',
    round: 3,
    maxRounds: 3,
    consensusReached: true,
    verdict: 'approved-with-fixes',
    testsPassed: 29,
    testsTotal: 29,
    issues: [
      {
        id: 'C1',
        title: 'JWT Secret Fallback Empty String',
        description:
          'Ha a JWT_SECRET nincs injektálva, a service üres string-et használ secret-ként. Ez katasztrofális biztonsági rés - bárki generálhat érvényes tokeneket.',
        severity: 'critical',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'token.service.ts',
        line: 77,
        category: 'Security',
      },
      {
        id: 'C2',
        title: 'Invalid Dummy Hash for Timing Attack Protection',
        description:
          'A dummy hash nem érvényes bcrypt hash (rossz hossz). A bcrypt.compare azonnal visszatér invalid hash esetén, így a timing attack védelem nem működik.',
        severity: 'critical',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'auth.service.ts',
        line: 96,
        category: 'Security',
      },
      {
        id: 'G1',
        title: 'Manuális és törékeny válasz- és hibakezelés a kontrollerben',
        description:
          'A kontroller @Res() dekorátorral közvetlenül kezeli a Response objektumot. Ez NestJS anti-pattern, megkerüli a beépített exception filtereket.',
        severity: 'critical',
        reviewer: 'Gemini',
        status: 'open',
        file: 'auth.controller.ts',
        line: 84,
        category: 'Architecture',
      },
      {
        id: 'H1',
        title: 'IP Spoofing Vulnerability in Rate Limiting',
        description:
          'A guard vakon megbízik az x-forwarded-for headerben. Támadó tetszőleges IP-t tud spoofing-olni, így megkerülheti a rate limitinget.',
        severity: 'high',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'login-throttle.guard.ts',
        line: 19,
        category: 'Security',
      },
      {
        id: 'H2',
        title: 'Silent Failure in Login Attempt Recording',
        description:
          'Ha a login attempt recording hibázik, nincs semmilyen logging. A security audit trail megszakadhat anélkül, hogy bárki észrevenné.',
        severity: 'high',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'auth.service.ts',
        line: 226,
        category: 'Reliability',
      },
      {
        id: 'H3',
        title: 'Error Handling Order in Controller',
        description:
          'A sikeres login utáni recordLoginAttempt hívás a try block-on belül van. Ha ez hibázik, a catch block failed attempt-et rögzít, holott a login sikeres volt.',
        severity: 'high',
        reviewer: 'Both',
        status: 'fixed',
        file: 'auth.controller.ts',
        line: 117,
        category: 'Logic',
      },
      {
        id: 'G3',
        title: 'findUserById duplication',
        description:
          'Az auth.service.ts tartalmaz egy private findUserById metódust. A felhasználók központi kezelése a @kgc/users csomag feladata.',
        severity: 'high',
        reviewer: 'Gemini',
        status: 'open',
        file: 'auth.service.ts',
        line: 384,
        category: 'DRY',
      },
      {
        id: 'M1',
        title: 'noUncheckedIndexedAccess Violation',
        description:
          'A match[1]! non-null assertion használata sérti a noUncheckedIndexedAccess strict TypeScript beállítást.',
        severity: 'medium',
        reviewer: 'Both',
        status: 'fixed',
        file: 'token.service.ts',
        line: 41,
        category: 'TypeScript',
      },
      {
        id: 'M2',
        title: 'Password Service Rounds Not Using DI',
        description:
          'A rounds paraméter közvetlenül van átadva, nem NestJS DI token-nel injektálva. Ez megnehezíti a konfigurációt és a tesztelést.',
        severity: 'medium',
        reviewer: 'Both',
        status: 'open',
        file: 'password.service.ts',
        line: 24,
        category: 'Architecture',
      },
      {
        id: 'M3',
        title: 'Redundant Method Override',
        description:
          'A canActivate() override nem csinál semmit, csak meghívja a parent-et. Felesleges kód.',
        severity: 'medium',
        reviewer: 'Both',
        status: 'fixed',
        file: 'jwt-auth.guard.ts',
        line: 18,
        category: 'Code Quality',
      },
      {
        id: 'M4',
        title: 'Type Safety Loss in Throttler Guard',
        description:
          'A req paraméter Record<string, unknown> típusú, ami elveszíti az Express Request type safety-t.',
        severity: 'medium',
        reviewer: 'Claude',
        status: 'open',
        file: 'login-throttle.guard.ts',
        line: 19,
        category: 'TypeScript',
      },
      {
        id: 'N1',
        title: 'Missing Rate Limit on Verify-Password Endpoint',
        description:
          'A verify-password endpoint-on a LoginThrottlerGuard a login rate limit-et használja. Az elevated access verification-nek külön rate limit kellene.',
        severity: 'medium',
        reviewer: 'Claude',
        status: 'open',
        file: 'auth.controller.ts',
        line: 542,
        category: 'Security',
      },
      {
        id: 'L1',
        title: 'Duplicated IP Extraction Logic',
        description:
          'Az IP kinyerés logika duplikálva van a controller-ben és a guard-ban. DRY violation.',
        severity: 'low',
        reviewer: 'Claude',
        status: 'open',
        file: 'auth.controller.ts',
        line: 74,
        category: 'DRY',
      },
      {
        id: 'N2',
        title: 'APP_BASE_URL Injection Without Validation',
        description:
          'Az APP_BASE_URL injection-nél nincs validation. Ha üres string vagy invalid URL, a password reset linkek hibásak lesznek.',
        severity: 'low',
        reviewer: 'Claude',
        status: 'open',
        file: 'auth.controller.ts',
        line: 76,
        category: 'Validation',
      },
    ],
  },
  {
    storyId: '1-2',
    storyName: 'Token Refresh Mechanism',
    epicId: '1',
    epicName: 'Authentication',
    package: '@kgc/auth',
    date: '2026-01-16',
    reviewer: 'Claude + Gemini',
    round: 2,
    maxRounds: 3,
    consensusReached: true,
    verdict: 'approved-with-fixes',
    testsPassed: 18,
    testsTotal: 18,
    issues: [
      {
        id: 'G-M3',
        title: 'Inkonzisztens hibakezelés',
        description:
          'A token.service.ts és auth.service.ts különböző módon kezelik a hibákat. Nincs egységes error handling pattern.',
        severity: 'medium',
        reviewer: 'Gemini',
        status: 'fixed',
        file: 'token.service.ts',
        line: 156,
        category: 'Consistency',
      },
      {
        id: 'G-L3',
        title: 'Felesleges passthrough',
        description:
          'A refreshToken metódus csak továbbhívja az alatta lévő service-t bármilyen extra logika nélkül.',
        severity: 'low',
        reviewer: 'Gemini',
        status: 'wontfix',
        file: 'auth.service.ts',
        line: 267,
        category: 'Code Quality',
      },
      {
        id: 'G-L4',
        title: 'Használaton kívüli request paraméter',
        description: 'A request paraméter nincs használva a refresh endpoint-ban.',
        severity: 'low',
        reviewer: 'Gemini',
        status: 'fixed',
        file: 'auth.controller.ts',
        line: 189,
        category: 'Dead Code',
      },
      {
        id: 'G-M4',
        title: 'findValidRefreshToken hiba',
        description: 'A findValidRefreshToken nem validálja a token expiry-t megfelelően.',
        severity: 'medium',
        reviewer: 'Gemini',
        status: 'fixed',
        file: 'token.service.ts',
        line: 203,
        category: 'Logic',
      },
    ],
  },
  {
    storyId: '1-3',
    storyName: 'Logout és Session Invalidation',
    epicId: '1',
    epicName: 'Authentication',
    package: '@kgc/auth',
    date: '2026-01-16',
    reviewer: 'Claude + Gemini',
    round: 2,
    maxRounds: 3,
    consensusReached: true,
    verdict: 'approved-with-fixes',
    testsPassed: 12,
    testsTotal: 12,
    issues: [
      {
        id: 'G-M5',
        title: 'DTO függőség',
        description: 'A logout DTO közvetlenül függ a token DTO-tól, ami szoros csatolást okoz.',
        severity: 'medium',
        reviewer: 'Gemini',
        status: 'open',
        file: 'logout.dto.ts',
        line: 8,
        category: 'Architecture',
      },
      {
        id: 'G-L8',
        title: 'Inkonzisztens as const',
        description:
          'Néhány helyen as const van használva, máshol nincs. Konvenciót kellene követni.',
        severity: 'low',
        reviewer: 'Gemini',
        status: 'fixed',
        file: 'session.constants.ts',
        line: 12,
        category: 'Consistency',
      },
      {
        id: 'G-M6',
        title: 'logoutAll Promise kezelés',
        description:
          'A logoutAll nem megfelelően kezeli a Promise rejection-öket concurrent session invalidation esetén.',
        severity: 'medium',
        reviewer: 'Gemini',
        status: 'fixed',
        file: 'auth.service.ts',
        line: 312,
        category: 'Error Handling',
      },
    ],
  },
  {
    storyId: '1-4',
    storyName: 'PIN Kód Belépés Kiosk Módban',
    epicId: '1',
    epicName: 'Authentication',
    package: '@kgc/auth',
    date: '2026-01-17',
    reviewer: 'Claude + Gemini',
    round: 2,
    maxRounds: 3,
    consensusReached: true,
    verdict: 'approved-with-fixes',
    testsPassed: 24,
    testsTotal: 24,
    issues: [
      {
        id: 'G-M7',
        title: 'Duplikált validation error',
        description:
          'A PIN validáció több helyen ugyanazt a hibaüzenetet dobja különböző error code-okkal.',
        severity: 'medium',
        reviewer: 'Gemini',
        status: 'fixed',
        file: 'pin.service.ts',
        line: 45,
        category: 'Consistency',
      },
      {
        id: 'G-M8',
        title: 'validatePinFormat private',
        description:
          'A validatePinFormat metódus private kellene legyen, de public-ként van definiálva.',
        severity: 'medium',
        reviewer: 'Gemini',
        status: 'fixed',
        file: 'pin.service.ts',
        line: 89,
        category: 'Encapsulation',
      },
      {
        id: 'G-L12',
        title: 'Duplikált bcrypt rounds',
        description: 'A bcrypt rounds konstans több helyen van definiálva.',
        severity: 'low',
        reviewer: 'Gemini',
        status: 'fixed',
        file: 'pin.service.ts',
        line: 15,
        category: 'DRY',
      },
      {
        id: 'G-M9',
        title: 'Duplikált trusted device interfész',
        description: 'A TrustedDevice interfész duplikálva van a types és interfaces mappában.',
        severity: 'medium',
        reviewer: 'Gemini',
        status: 'open',
        file: 'trusted-device.interface.ts',
        line: 1,
        category: 'DRY',
      },
      {
        id: 'G-M10',
        title: 'Hibaelnyelés resetAttempts',
        description: 'A resetAttempts metódus elnyeli a hibákat logging nélkül.',
        severity: 'medium',
        reviewer: 'Gemini',
        status: 'fixed',
        file: 'pin-lockout.service.ts',
        line: 78,
        category: 'Error Handling',
      },
    ],
  },
  {
    storyId: '1-5',
    storyName: 'Password Reset Flow',
    epicId: '1',
    epicName: 'Authentication',
    package: '@kgc/auth',
    date: '2026-01-17',
    reviewer: 'Claude + Gemini',
    round: 2,
    maxRounds: 3,
    consensusReached: true,
    verdict: 'approved-with-fixes',
    testsPassed: 15,
    testsTotal: 15,
    issues: [
      {
        id: 'G-M11',
        title: 'Duplikált validation error DTO',
        description: 'A password reset DTO-k duplikálják a validációs hibakezelést más DTO-kból.',
        severity: 'medium',
        reviewer: 'Gemini',
        status: 'fixed',
        file: 'password-reset.dto.ts',
        line: 23,
        category: 'DRY',
      },
      {
        id: 'G-M12',
        title: 'In-memory rate limiting',
        description:
          'A password reset rate limiting in-memory, ami nem működik több instance esetén.',
        severity: 'medium',
        reviewer: 'Gemini',
        status: 'deferred',
        file: 'password-reset.service.ts',
        line: 67,
        category: 'Scalability',
      },
      {
        id: 'G-L16',
        title: 'Hiányzó cleanup hívás',
        description: 'Az expired token cleanup nincs automatikusan ütemezve.',
        severity: 'low',
        reviewer: 'Gemini',
        status: 'open',
        file: 'password-reset.service.ts',
        line: 156,
        category: 'Maintenance',
      },
      {
        id: 'G-L18',
        title: 'Mock email service teszt fájlban',
        description:
          'A mock email service közvetlenül a spec fájlban van definiálva, nem külön testing module-ban.',
        severity: 'low',
        reviewer: 'Gemini',
        status: 'open',
        file: 'password-reset.service.spec.ts',
        line: 34,
        category: 'Testing',
      },
    ],
  },
];

// Epic 2: User Management (@kgc/users)
export const EPIC_2_REVIEWS: StoryReview[] = [
  {
    storyId: '2-1',
    storyName: 'User CRUD Operations',
    epicId: '2',
    epicName: 'User Management',
    package: '@kgc/users',
    date: '2026-01-18',
    reviewer: 'Claude + Gemini',
    round: 1,
    maxRounds: 3,
    consensusReached: false,
    verdict: 'in-progress',
    testsPassed: 42,
    testsTotal: 45,
    issues: [
      {
        id: 'C1',
        title: 'PermissionService Not Injected via DI',
        description:
          'A PermissionService manuálisan van létrehozva a konstruktorban, nem dependency injection-nel. Lehetetlenné teszi a mock-olást teszteknél.',
        severity: 'critical',
        reviewer: 'Claude',
        status: 'open',
        file: 'users.service.ts',
        line: 64,
        category: 'Architecture',
      },
      {
        id: 'C2',
        title: 'Manual Response Handling - NestJS Anti-Pattern',
        description:
          'MINDEN endpoint @Res() dekoratort használ manuális response kezelésre. Lehetetlenné teszi az interceptorok működését.',
        severity: 'critical',
        reviewer: 'Claude',
        status: 'open',
        file: 'users.controller.ts',
        line: 84,
        category: 'Architecture',
      },
      {
        id: 'G-C1',
        title: 'Permission Service DI in PermissionService',
        description: 'A PermissionService önmagát használja zárványként a RoleService-ben.',
        severity: 'critical',
        reviewer: 'Gemini',
        status: 'open',
        file: 'permission.service.ts',
        line: 45,
        category: 'Architecture',
      },
      {
        id: 'H1',
        title: 'Generic Error Throwing Instead of HttpException',
        description:
          'A service réteg általános Error objektumokat dob HTTP-specifikus kivételek helyett.',
        severity: 'high',
        reviewer: 'Claude',
        status: 'open',
        file: 'users.service.ts',
        line: 102,
        category: 'Error Handling',
      },
      {
        id: 'H2',
        title: 'Fragile String-Based Error Handling',
        description:
          'A hibaüzenetek szövege alapján történik a HTTP státusz meghatározása. Ha valaki módosítja a konstans értékét, a hibakezelés elromlik.',
        severity: 'high',
        reviewer: 'Claude',
        status: 'open',
        file: 'users.controller.ts',
        line: 449,
        category: 'Maintainability',
      },
      {
        id: 'G-H1',
        title: 'Generic Error Handling in Role Service',
        description: 'A RoleService általános hibákat dob specifikus HTTP exception-ök helyett.',
        severity: 'high',
        reviewer: 'Gemini',
        status: 'open',
        file: 'role.service.ts',
        line: 78,
        category: 'Error Handling',
      },
      {
        id: 'M1',
        title: 'Manual DTO Validation Functions',
        description:
          'Minden endpoint-ban manuálisan hívjuk meg a validációs függvényeket. A NestJS ValidationPipe automatikusan kezelné.',
        severity: 'medium',
        reviewer: 'Claude',
        status: 'open',
        file: 'users.controller.ts',
        line: 90,
        category: 'NestJS Convention',
      },
      {
        id: 'G-M2',
        title: 'Prisma Null Check Inconsistency',
        description: 'Egyes helyeken van Prisma null check, máshol nincs. Inkonzisztens kezelés.',
        severity: 'medium',
        reviewer: 'Gemini',
        status: 'open',
        file: 'users.service.ts',
        line: 156,
        category: 'Consistency',
      },
    ],
  },
  {
    storyId: '2-2',
    storyName: 'Role Assignment és RBAC',
    epicId: '2',
    epicName: 'User Management',
    package: '@kgc/users',
    date: '2026-01-18',
    reviewer: 'Claude + Gemini',
    round: 1,
    maxRounds: 3,
    consensusReached: false,
    verdict: 'in-progress',
    testsPassed: 35,
    testsTotal: 38,
    issues: [
      {
        id: 'G-C1',
        title: 'RoleService DI in PermissionService',
        description: 'A PermissionService konstruktorában a RoleService nincs DI-vel injektálva.',
        severity: 'critical',
        reviewer: 'Gemini',
        status: 'open',
        file: 'permission.service.ts',
        line: 23,
        category: 'Architecture',
      },
      {
        id: 'G-M1',
        title: 'Inconsistent Validation Error',
        description: 'A role assignment validáció különböző hibakódokat használ hasonló esetekre.',
        severity: 'medium',
        reviewer: 'Gemini',
        status: 'open',
        file: 'role.service.ts',
        line: 89,
        category: 'Consistency',
      },
      {
        id: 'G-M2',
        title: 'Inefficient getConstraint',
        description: 'A getConstraint minden hívásnál újra lekérdezi az összes constraint-et.',
        severity: 'medium',
        reviewer: 'Gemini',
        status: 'open',
        file: 'permission.service.ts',
        line: 145,
        category: 'Performance',
      },
    ],
  },
  {
    storyId: '2-3',
    storyName: 'Permission Check Middleware',
    epicId: '2',
    epicName: 'User Management',
    package: '@kgc/users',
    date: '2026-01-18',
    reviewer: 'Claude + Gemini',
    round: 1,
    maxRounds: 3,
    consensusReached: false,
    verdict: 'in-progress',
    testsPassed: 28,
    testsTotal: 32,
    issues: [
      {
        id: 'G-C1',
        title: 'Incorrect Metadata Composition',
        description: 'A guard nem megfelelően kombinálja a class és method level metadata-t.',
        severity: 'critical',
        reviewer: 'Gemini',
        status: 'open',
        file: 'permission.guard.ts',
        line: 34,
        category: 'Logic',
      },
      {
        id: 'G-C2',
        title: 'PermissionService DI in Guard',
        description: 'A guard közvetlenül példányosítja a PermissionService-t DI helyett.',
        severity: 'critical',
        reviewer: 'Gemini',
        status: 'open',
        file: 'permission.guard.ts',
        line: 18,
        category: 'Architecture',
      },
      {
        id: 'G-C3',
        title: 'Guard is Non-Functional',
        description: 'A guard mindig true-t ad vissza, nem végez tényleges permission check-et.',
        severity: 'critical',
        reviewer: 'Gemini',
        status: 'open',
        file: 'permission.guard.ts',
        line: 67,
        category: 'Functionality',
      },
    ],
  },
];

// Epic 17: Service Worksheet (@kgc/service-worksheet)
export const EPIC_17_REVIEWS: StoryReview[] = [
  {
    storyId: '17-epic',
    storyName: 'Work Orders (Epic 17 - 8 stories)',
    epicId: '17',
    epicName: 'Work Orders',
    package: '@kgc/service-worksheet',
    date: '2026-01-17',
    reviewer: 'Claude',
    round: 1,
    maxRounds: 1,
    consensusReached: true,
    verdict: 'approved-with-fixes',
    testsPassed: 137,
    testsTotal: 137,
    issues: [
      {
        id: 'H1',
        title: 'Repository Interface Inconsistency',
        description:
          "findByWorksheetId accepted tenantId parameter but the repository doesn't actually need it (tenant isolation is done earlier).",
        severity: 'high',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'diagnosis.service.ts',
        line: 17,
        category: 'Interface Design',
        autoFixed: true,
      },
      {
        id: 'H2',
        title: 'Missing Repository Method',
        description:
          "WorksheetQueueService uses findByStatus method which wasn't defined in IWorksheetRepository.",
        severity: 'high',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'worksheet.service.ts',
        line: 37,
        category: 'Interface Design',
        autoFixed: true,
      },
      {
        id: 'M1',
        title: 'Missing NestJS Module',
        description: 'No service-worksheet.module.ts for dependency injection.',
        severity: 'medium',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'service-worksheet.module.ts',
        category: 'Architecture',
        autoFixed: true,
      },
      {
        id: 'M2',
        title: 'Unclear Null Handling in Unlink',
        description:
          'Using undefined to clear rentalId field. In Prisma, undefined means "don\'t update" while null means "set to null".',
        severity: 'medium',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'worksheet-rental.service.ts',
        line: 125,
        category: 'Prisma',
        autoFixed: true,
      },
      {
        id: 'M3',
        title: 'Module Not Exported',
        description: 'New module file not exported from barrel index.ts.',
        severity: 'medium',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'index.ts',
        category: 'Exports',
        autoFixed: true,
      },
      {
        id: 'L1',
        title: 'Error Message Inconsistency',
        description:
          'Some files use accented Hungarian (e.g., "nem található") while others use ASCII (e.g., "nem talalhato").',
        severity: 'low',
        reviewer: 'Claude',
        status: 'wontfix',
        file: 'various',
        category: 'Consistency',
      },
    ],
  },
];

// Epic 18: Sales Quote (@kgc/sales-quote)
export const EPIC_18_REVIEWS: StoryReview[] = [
  {
    storyId: '18-epic',
    storyName: 'Sales Quote (Epic 18 - 4 stories)',
    epicId: '18',
    epicName: 'Quotations',
    package: '@kgc/sales-quote',
    date: '2026-01-17',
    reviewer: 'Claude',
    round: 1,
    maxRounds: 1,
    consensusReached: true,
    verdict: 'approved-with-fixes',
    testsPassed: 25,
    testsTotal: 25,
    issues: [
      {
        id: 'H1',
        title: 'VAT Rate Hardcoded',
        description:
          'VAT rate (0.27) is hardcoded. Should be configurable for different scenarios (exempt, reduced rate).',
        severity: 'high',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'quote.service.ts',
        line: 73,
        category: 'Configuration',
        autoFixed: true,
      },
      {
        id: 'H2',
        title: 'Missing Tenant Validation in Acceptance',
        description:
          "acceptQuote and rejectQuote don't validate that the quote belongs to the tenant. Security vulnerability.",
        severity: 'high',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'quote-acceptance.service.ts',
        line: 37,
        category: 'Security',
        autoFixed: true,
      },
      {
        id: 'M1',
        title: 'Missing Audit Logging in Acceptance',
        description: 'No audit trail for quote acceptance/rejection operations.',
        severity: 'medium',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'quote-acceptance.service.ts',
        category: 'Audit',
        autoFixed: true,
      },
      {
        id: 'M2',
        title: 'Missing Email Validation',
        description: 'No validation of recipientEmail format before sending.',
        severity: 'medium',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'quote-export.service.ts',
        line: 85,
        category: 'Validation',
        autoFixed: true,
      },
      {
        id: 'M3',
        title: 'Missing Tenant Validation in Export',
        description:
          "generatePdf doesn't validate partner belongs to same tenant. Potential cross-tenant data leak.",
        severity: 'medium',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'quote-export.service.ts',
        line: 44,
        category: 'Security',
        autoFixed: true,
      },
      {
        id: 'M4',
        title: 'Missing QuoteService CRUD Operations',
        description:
          'Only createQuote is implemented. Missing findById, update, delete, sendQuote.',
        severity: 'medium',
        reviewer: 'Claude',
        status: 'deferred',
        file: 'quote.service.ts',
        category: 'Completeness',
      },
      {
        id: 'M5',
        title: 'Missing Tenant Validation in ExplodedView',
        description: "selectPart doesn't validate tenantId.",
        severity: 'medium',
        reviewer: 'Claude',
        status: 'deferred',
        file: 'exploded-view.service.ts',
        line: 21,
        category: 'Security',
      },
      {
        id: 'L1',
        title: 'Mock PDF Generation',
        description: 'Using JSON.stringify instead of real PDF library. Not production-ready.',
        severity: 'low',
        reviewer: 'Claude',
        status: 'deferred',
        file: 'quote-export.service.ts',
        line: 82,
        category: 'Infrastructure',
      },
    ],
  },
];

// Epic 20: Service Norma (@kgc/service-norma)
export const EPIC_20_REVIEWS: StoryReview[] = [
  {
    storyId: '20-epic',
    storyName: 'Service Standards (Epic 20 - 3 stories)',
    epicId: '20',
    epicName: 'Service Standards',
    package: '@kgc/service-norma',
    date: '2026-01-17',
    reviewer: 'Claude',
    round: 1,
    maxRounds: 1,
    consensusReached: true,
    verdict: 'approved-with-fixes',
    testsPassed: 29,
    testsTotal: 29,
    issues: [
      {
        id: 'H1',
        title: "CSV Parsing Doesn't Handle Quoted Fields",
        description:
          'The CSV parser uses simple comma splitting which will break if fields contain commas (e.g., "Motor, 3-phase").',
        severity: 'high',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'norma-import.service.ts',
        line: 172,
        category: 'Data Parsing',
        autoFixed: true,
      },
      {
        id: 'M1',
        title: 'No Duplicate Norma Code Check',
        description:
          "During import, there's no check for duplicate norma codes within the same import batch.",
        severity: 'medium',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'norma-import.service.ts',
        line: 62,
        category: 'Validation',
        autoFixed: true,
      },
      {
        id: 'M2',
        title: 'searchNormaCodes Loads All Items Into Memory',
        description:
          "The search loads all items from a version into memory and filters client-side. Doesn't scale.",
        severity: 'medium',
        reviewer: 'Claude',
        status: 'deferred',
        file: 'norma-labor.service.ts',
        line: 132,
        category: 'Performance',
      },
      {
        id: 'M3',
        title: 'Missing Warranty Check',
        description:
          "The worksheet has isWarranty flag but it's not used. Norma pricing typically only applies to warranty work.",
        severity: 'medium',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'norma-labor.service.ts',
        line: 44,
        category: 'Business Logic',
        autoFixed: true,
      },
      {
        id: 'M4',
        title: 'No Transaction Wrapper',
        description:
          'The import creates version, archives old version, and creates items without a transaction.',
        severity: 'medium',
        reviewer: 'Claude',
        status: 'deferred',
        file: 'norma-import.service.ts',
        line: 103,
        category: 'Data Integrity',
      },
      {
        id: 'L1',
        title: 'Missing List Versions Method',
        description:
          "There's no method to list all versions for a supplier (for UI version history).",
        severity: 'low',
        reviewer: 'Claude',
        status: 'deferred',
        file: 'norma-version.service.ts',
        category: 'Completeness',
      },
      {
        id: 'L2',
        title: 'Hourly Rate Validation Warning',
        description: 'If hourlyRate is 0, labor cost will be 0 which might be unintended.',
        severity: 'low',
        reviewer: 'Claude',
        status: 'wontfix',
        file: 'norma-import.service.ts',
        line: 85,
        category: 'Validation',
      },
    ],
  },
];

// Epic 21: Goods Receipt (@kgc/bevetelezes)
export const EPIC_21_REVIEWS: StoryReview[] = [
  {
    storyId: '21-epic',
    storyName: 'Goods Receipt (Epic 21 - 3 stories)',
    epicId: '21',
    epicName: 'Goods Receipt',
    package: '@kgc/bevetelezes',
    date: '2026-01-17',
    reviewer: 'Claude',
    round: 1,
    maxRounds: 1,
    consensusReached: true,
    verdict: 'approved-with-fixes',
    testsPassed: 26,
    testsTotal: 26,
    issues: [
      {
        id: 'H1',
        title: 'Avizo Item Received Quantity Not Updated',
        description:
          "When creating a receipt linked to an avizo, the avizo item's receivedQuantity field was never updated.",
        severity: 'high',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'receipt.service.ts',
        line: 120,
        category: 'Business Logic',
        autoFixed: true,
      },
      {
        id: 'M1',
        title: 'hasDiscrepancy Flag Not Reset',
        description: 'When all discrepancies were resolved, hasDiscrepancy remained true.',
        severity: 'medium',
        reviewer: 'Claude',
        status: 'fixed',
        file: 'discrepancy.service.ts',
        line: 159,
        category: 'State Management',
        autoFixed: true,
      },
      {
        id: 'M2',
        title: 'No Transaction Wrapper',
        description:
          'Multiple database operations happen without a transaction. Partial data could be left.',
        severity: 'medium',
        reviewer: 'Claude',
        status: 'deferred',
        file: 'receipt.service.ts',
        line: 105,
        category: 'Data Integrity',
      },
      {
        id: 'M3',
        title: 'Missing Supplier Validation',
        description:
          "When creating a receipt without an avizo, there's no validation that the supplierId exists.",
        severity: 'medium',
        reviewer: 'Claude',
        status: 'deferred',
        file: 'receipt.service.ts',
        line: 63,
        category: 'Validation',
      },
      {
        id: 'L1',
        title: 'DRAFT Status Unused',
        description: 'ReceiptStatus.DRAFT is defined but never used in the service.',
        severity: 'low',
        reviewer: 'Claude',
        status: 'wontfix',
        file: 'receipt.interface.ts',
        line: 6,
        category: 'Dead Code',
      },
      {
        id: 'L2',
        title: 'Missing getReceiptsBySupplier Method',
        description: 'No method to list receipts by supplier for reporting and audit.',
        severity: 'low',
        reviewer: 'Claude',
        status: 'deferred',
        file: 'receipt.service.ts',
        category: 'Completeness',
      },
    ],
  },
];

// All reviews combined
export const ALL_REVIEWS: StoryReview[] = [
  ...EPIC_1_REVIEWS,
  ...EPIC_2_REVIEWS,
  ...EPIC_17_REVIEWS,
  ...EPIC_18_REVIEWS,
  ...EPIC_20_REVIEWS,
  ...EPIC_21_REVIEWS,
];

// Helper functions
export function getReviewsByEpic(epicId: string): StoryReview[] {
  return ALL_REVIEWS.filter(r => r.epicId === epicId);
}

export function getReviewStats() {
  const allIssues = ALL_REVIEWS.flatMap(r => r.issues);
  return {
    totalReviews: ALL_REVIEWS.length,
    totalIssues: allIssues.length,
    critical: allIssues.filter(i => i.severity === 'critical').length,
    high: allIssues.filter(i => i.severity === 'high').length,
    medium: allIssues.filter(i => i.severity === 'medium').length,
    low: allIssues.filter(i => i.severity === 'low').length,
    fixed: allIssues.filter(i => i.status === 'fixed').length,
    open: allIssues.filter(i => i.status === 'open').length,
    deferred: allIssues.filter(i => i.status === 'deferred').length,
    wontfix: allIssues.filter(i => i.status === 'wontfix').length,
    autoFixed: allIssues.filter(i => i.autoFixed).length,
    claudeIssues: allIssues.filter(i => i.reviewer === 'Claude' || i.reviewer === 'Both').length,
    geminiIssues: allIssues.filter(i => i.reviewer === 'Gemini' || i.reviewer === 'Both').length,
    consensusReached: ALL_REVIEWS.filter(r => r.consensusReached).length,
    approvedWithFixes: ALL_REVIEWS.filter(r => r.verdict === 'approved-with-fixes').length,
    inProgress: ALL_REVIEWS.filter(r => r.verdict === 'in-progress').length,
  };
}
