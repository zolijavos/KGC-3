// Sales Invoice Schema
// Package: @kgc/sales-invoice
// Epic 10: Invoice Core

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// INVOICE STATUS ENUM
// ============================================
enum InvoiceStatus {
  DRAFT              // Piszkozat
  ISSUED             // Kiállítva
  SENT               // Elküldve
  PAID               // Fizetve
  PARTIALLY_PAID     // Részben fizetve
  OVERDUE            // Lejárt
  CANCELLED          // Sztornózva
}

// ============================================
// INVOICE TYPE ENUM
// ============================================
enum InvoiceType {
  STANDARD           // Normál számla
  PROFORMA           // Proforma számla
  CORRECTION         // Helyesbítő számla
  STORNO             // Sztornó számla
  ADVANCE            // Előleg számla
  FINAL              // Végszámla
}

// ============================================
// PAYMENT METHOD ENUM
// ============================================
enum PaymentMethod {
  CASH               // Készpénz
  CARD               // Bankkártya
  TRANSFER           // Átutalás
  COD                // Utánvét
}

// ============================================
// VAT RATE ENUM (Hungarian)
// ============================================
enum VatRate {
  RATE_27            // 27% - Általános
  RATE_18            // 18% - Élelmiszer
  RATE_5             // 5% - Kedvezményes
  RATE_0             // 0% - Mentes
  AAM                // Alanyi adómentes
  TAM                // Tárgyi adómentes
  EU                 // EU értékesítés
  EUK                // EU szolgáltatás
  MAA                // Mentes az adó alól
}

// ============================================
// INVOICE
// ============================================
model Invoice {
  id                String        @id @default(uuid()) @db.Uuid
  tenantId          String        @map("tenant_id") @db.Uuid

  // Számla azonosítók
  invoiceNumber     String        @map("invoice_number") @db.VarChar(50)
  prefix            String        @db.VarChar(10)
  sequenceNumber    Int           @map("sequence_number")

  // Típus és státusz
  type              InvoiceType   @default(STANDARD)
  status            InvoiceStatus @default(DRAFT)

  // Partner
  partnerId         String        @map("partner_id") @db.Uuid
  partnerName       String        @map("partner_name") @db.VarChar(255)
  partnerTaxNumber  String?       @map("partner_tax_number") @db.VarChar(20)
  partnerAddress    String        @map("partner_address") @db.VarChar(500)

  // Kapcsolódó entitások
  rentalId          String?       @map("rental_id") @db.Uuid
  serviceOrderId    String?       @map("service_order_id") @db.Uuid
  quotationId       String?       @map("quotation_id") @db.Uuid

  // Hivatkozott számla (sztornó/helyesbítő esetén)
  referencedInvoiceId String?     @map("referenced_invoice_id") @db.Uuid
  referencedInvoice Invoice?      @relation("InvoiceReference", fields: [referencedInvoiceId], references: [id])
  referencingInvoices Invoice[]   @relation("InvoiceReference")

  // Dátumok
  invoiceDate       DateTime      @map("invoice_date") @db.Date
  fulfillmentDate   DateTime      @map("fulfillment_date") @db.Date
  dueDate           DateTime      @map("due_date") @db.Date
  paidAt            DateTime?     @map("paid_at")

  // Fizetés
  paymentMethod     PaymentMethod @map("payment_method")
  paymentReference  String?       @map("payment_reference") @db.VarChar(100)

  // Összegek (Decimal a pontosságért)
  netAmount         Decimal       @map("net_amount") @db.Decimal(12, 2)
  vatAmount         Decimal       @map("vat_amount") @db.Decimal(12, 2)
  grossAmount       Decimal       @map("gross_amount") @db.Decimal(12, 2)
  paidAmount        Decimal       @default(0) @map("paid_amount") @db.Decimal(12, 2)
  currency          String        @default("HUF") @db.Char(3)

  // NAV integráció
  navStatus         String?       @map("nav_status") @db.VarChar(20)
  navTransactionId  String?       @map("nav_transaction_id") @db.VarChar(100)
  navSubmittedAt    DateTime?     @map("nav_submitted_at")

  // PDF
  pdfUrl            String?       @map("pdf_url")
  pdfGeneratedAt    DateTime?     @map("pdf_generated_at")

  // Megjegyzés
  notes             String?
  internalNotes     String?       @map("internal_notes")

  // RBAC - láthatóság
  isConfidential    Boolean       @default(false) @map("is_confidential")
  visibleToRoles    String[]      @default([]) @map("visible_to_roles")

  // Audit
  createdAt         DateTime      @default(now()) @map("created_at")
  createdBy         String        @map("created_by") @db.Uuid
  updatedAt         DateTime      @updatedAt @map("updated_at")
  updatedBy         String?       @map("updated_by") @db.Uuid
  cancelledAt       DateTime?     @map("cancelled_at")
  cancelledBy       String?       @map("cancelled_by") @db.Uuid
  cancellationReason String?      @map("cancellation_reason")

  // Kapcsolatok
  items             InvoiceItem[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId, status])
  @@index([tenantId, partnerId])
  @@index([tenantId, invoiceDate])
  @@index([tenantId, dueDate, status])
  @@map("invoice")
}

// ============================================
// INVOICE ITEM
// ============================================
model InvoiceItem {
  id                String      @id @default(uuid()) @db.Uuid
  invoiceId         String      @map("invoice_id") @db.Uuid

  // Sorrend
  lineNumber        Int         @map("line_number")

  // Tétel adatok
  description       String      @db.VarChar(500)
  quantity          Decimal     @db.Decimal(12, 4)
  unit              String      @db.VarChar(20)
  unitPriceNet      Decimal     @map("unit_price_net") @db.Decimal(12, 2)

  // ÁFA
  vatRate           VatRate     @map("vat_rate")
  vatPercentage     Decimal     @map("vat_percentage") @db.Decimal(5, 2)

  // Összegek
  netAmount         Decimal     @map("net_amount") @db.Decimal(12, 2)
  vatAmount         Decimal     @map("vat_amount") @db.Decimal(12, 2)
  grossAmount       Decimal     @map("gross_amount") @db.Decimal(12, 2)

  // Kedvezmény
  discountPercent   Decimal?    @map("discount_percent") @db.Decimal(5, 2)
  discountAmount    Decimal?    @map("discount_amount") @db.Decimal(12, 2)

  // Kapcsolódó entitások
  productId         String?     @map("product_id") @db.Uuid
  rentalItemId      String?     @map("rental_item_id") @db.Uuid
  serviceItemId     String?     @map("service_item_id") @db.Uuid

  invoice           Invoice     @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_item")
}

// ============================================
// INVOICE SEQUENCE (számla sorszám generálás)
// ============================================
model InvoiceSequence {
  id                String      @id @default(uuid()) @db.Uuid
  tenantId          String      @map("tenant_id") @db.Uuid
  prefix            String      @db.VarChar(10)
  year              Int
  lastNumber        Int         @default(0) @map("last_number")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  @@unique([tenantId, prefix, year])
  @@map("invoice_sequence")
}
