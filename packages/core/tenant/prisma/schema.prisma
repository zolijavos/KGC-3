// This is the Prisma schema for @kgc/tenant module
// Multi-tenant infrastruktúra - Tenant entity és kapcsolódó típusok

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// TENANT ENTITY
// ===========================================

model Tenant {
  id              String       @id @default(uuid())
  name            String       @db.VarChar(255)
  slug            String       @unique @db.VarChar(100)
  status          TenantStatus @default(PENDING)
  settings        Json         @default("{}")

  // Holding struktúra (Story 3-6)
  parentTenantId  String?      @map("parent_tenant_id")
  parentTenant    Tenant?      @relation("TenantHierarchy", fields: [parentTenantId], references: [id])
  childTenants    Tenant[]     @relation("TenantHierarchy")

  // Schema info
  schemaName      String?      @map("schema_name") @db.VarChar(100)
  schemaCreatedAt DateTime?    @map("schema_created_at")

  // Timestamps
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  deletedAt       DateTime?    @map("deleted_at")

  @@map("tenants")
  @@index([status])
  @@index([parentTenantId])
}

// ===========================================
// ENUMS
// ===========================================

enum TenantStatus {
  PENDING    // Onboarding folyamatban
  ACTIVE     // Aktív tenant
  INACTIVE   // Soft deleted / inaktív
  SUSPENDED  // Felfüggesztett (fizetési probléma)
}

// ===========================================
// TENANT AUDIT LOG (for tracking changes)
// ===========================================

model TenantAuditLog {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  action    String   @db.VarChar(50)  // CREATE, UPDATE, DELETE, STATUS_CHANGE
  changes   Json     @default("{}")    // JSON diff of changes
  userId    String?  @map("user_id")   // Who made the change
  createdAt DateTime @default(now()) @map("created_at")

  @@map("tenant_audit_logs")
  @@index([tenantId])
  @@index([createdAt])
}
