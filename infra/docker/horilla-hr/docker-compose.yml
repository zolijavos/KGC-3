# Horilla HR Docker Compose Configuration
# KGC ERP Integration - Story 33-3
# Documentation: ./README.md

name: kgc-horilla-hr

services:
  # ===========================================
  # Horilla HR Application (Django)
  # ===========================================
  horilla-app:
    image: horilla/horilla:1.4
    container_name: kgc-horilla-app
    ports:
      - '127.0.0.1:${HORILLA_PORT:-3003}:8000'
    depends_on:
      horilla-db:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    environment:
      # Django Settings
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY:?DJANGO_SECRET_KEY is required}
      DJANGO_DEBUG: ${DJANGO_DEBUG:-False}
      DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS:-localhost,127.0.0.1,horilla-app}

      # Database
      DATABASE_URL: postgres://${POSTGRES_USER:-horilla}:${POSTGRES_PASSWORD:-horilla}@horilla-db:5432/${POSTGRES_DB:-horilla}
      DB_HOST: horilla-db
      DB_PORT: 5432
      DB_NAME: ${POSTGRES_DB:-horilla}
      DB_USER: ${POSTGRES_USER:-horilla}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-horilla}

      # Application
      SITE_URL: ${SITE_URL:-http://localhost:3003}
      CSRF_TRUSTED_ORIGINS: ${CSRF_TRUSTED_ORIGINS:-http://localhost:3003,http://127.0.0.1:3003}

      # Email (optional)
      EMAIL_HOST: ${EMAIL_HOST:-}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_HOST_USER: ${EMAIL_HOST_USER:-}
      EMAIL_HOST_PASSWORD: ${EMAIL_HOST_PASSWORD:-}
      EMAIL_USE_TLS: ${EMAIL_USE_TLS:-True}

      # KGC Integration (placeholder)
      # KGC_API_URL: ${KGC_API_URL:-http://host.docker.internal:3000}
      # KGC_API_KEY: ${KGC_API_KEY:-}
    volumes:
      - horilla-static:/app/staticfiles
      - horilla-media:/app/media
      - ./entrypoint-override.sh:/app/entrypoint-kgc.sh:ro
    entrypoint: ['/bin/bash', '/app/entrypoint-kgc.sh']
    healthcheck:
      # Use Python since curl is not available in the container
      test:
        [
          'CMD-SHELL',
          'python3 -c "import urllib.request; urllib.request.urlopen(\"http://localhost:8000/\", timeout=5)" || exit 1',
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped
    networks:
      - kgc-network

  # ===========================================
  # PostgreSQL Database (Horilla HR Only)
  # ===========================================
  horilla-db:
    image: postgres:16-alpine
    container_name: kgc-horilla-db
    ports:
      - '127.0.0.1:${HORILLA_DB_PORT:-5434}:5432'
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-horilla}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required - set in .env file}
      POSTGRES_DB: ${POSTGRES_DB:-horilla}
    volumes:
      - horilla-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-horilla} -d ${POSTGRES_DB:-horilla}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - kgc-network

# ===========================================
# Volumes (Persistent Data)
# ===========================================
volumes:
  horilla-db-data:
    name: kgc-horilla-db-data
  horilla-static:
    name: kgc-horilla-static
  horilla-media:
    name: kgc-horilla-media

# ===========================================
# Networks
# ===========================================
networks:
  kgc-network:
    name: kgc-demo-network
    external: true # Connect to existing KGC demo network for API integration
