# ==============================================================================
# KGC ERP v7.0 - Full Stack Docker Compose
# Epic 33-4: Unified Development & Production Environment
# ==============================================================================
#
# Services:
#   - KGC Core: API (3000), Web (80), PostgreSQL (5432), Redis (6379), MinIO (9000/9001)
#   - Twenty CRM: Server (3001), Worker, PostgreSQL (5433), Redis (6380)
#   - Chatwoot: Rails (3002), Sidekiq, PostgreSQL (5435), Redis (6381)
#   - Horilla HR: App (3003), PostgreSQL (5434)
#
# Usage:
#   docker compose -f docker-compose.yml --env-file .env up -d
#   docker compose -f docker-compose.yml --env-file .env down
#
# ==============================================================================

name: kgc-erp-full-stack

# ==============================================================================
# SHARED ANCHORS (YAML DRY)
# ==============================================================================
x-logging: &default-logging
  driver: 'json-file'
  options:
    max-size: '10m'
    max-file: '3'

x-healthcheck-db: &healthcheck-db
  interval: 10s
  timeout: 5s
  retries: 5
  start_period: 30s

x-healthcheck-app: &healthcheck-app
  interval: 30s
  timeout: 10s
  retries: 5
  start_period: 60s

services:
  # ============================================================================
  # KGC CORE SERVICES
  # ============================================================================

  # --------------------------------------------------------------------------
  # KGC API (NestJS Backend)
  # --------------------------------------------------------------------------
  kgc-api:
    build:
      context: ../../../
      dockerfile: apps/kgc-api/Dockerfile
    container_name: kgc-api
    ports:
      - '${KGC_API_PORT:-3000}:3000'
    depends_on:
      kgc-db:
        condition: service_healthy
      kgc-redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
    logging: *default-logging
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_URL: postgresql://${KGC_DB_USER:-kgc}:${KGC_DB_PASSWORD}@kgc-db:5432/${KGC_DB_NAME:-kgc_erp}
      REDIS_URL: redis://kgc-redis:6379
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-${JWT_SECRET}}
      APP_BASE_URL: ${APP_BASE_URL:-http://localhost:3000}
      MINIO_ENDPOINT: kgc-minio
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      # Integration URLs
      TWENTY_CRM_URL: http://twenty-server:3000
      CHATWOOT_URL: http://chatwoot-rails:3000
      HORILLA_URL: http://horilla-app:8000
    healthcheck:
      test:
        ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3000/api/health']
      <<: *healthcheck-app
    restart: unless-stopped
    networks:
      - kgc-network

  # --------------------------------------------------------------------------
  # KGC Web (Vite + React PWA Frontend)
  # --------------------------------------------------------------------------
  kgc-web:
    build:
      context: ../../../
      dockerfile: apps/kgc-web/Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:3000}
        VITE_APP_NAME: ${VITE_APP_NAME:-KGC_ERP}
        VITE_APP_VERSION: ${VITE_APP_VERSION:-7.0.0}
    container_name: kgc-web
    ports:
      - '${KGC_WEB_PORT:-80}:80'
    depends_on:
      kgc-api:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 64M
    logging: *default-logging
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:80/health']
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - kgc-network

  # --------------------------------------------------------------------------
  # KGC PostgreSQL Database
  # --------------------------------------------------------------------------
  kgc-db:
    image: postgres:16-alpine
    container_name: kgc-db
    ports:
      - '${KGC_DB_PORT:-5432}:5432'
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
    logging: *default-logging
    environment:
      POSTGRES_USER: ${KGC_DB_USER:-kgc}
      POSTGRES_PASSWORD: ${KGC_DB_PASSWORD:?KGC_DB_PASSWORD is required}
      POSTGRES_DB: ${KGC_DB_NAME:-kgc_erp}
    volumes:
      - kgc-db-data:/var/lib/postgresql/data
      - ../postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${KGC_DB_USER:-kgc} -d ${KGC_DB_NAME:-kgc_erp}']
      <<: *healthcheck-db
    restart: unless-stopped
    networks:
      - kgc-network

  # --------------------------------------------------------------------------
  # KGC Redis Cache
  # --------------------------------------------------------------------------
  kgc-redis:
    image: redis:7-alpine
    container_name: kgc-redis
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - '${KGC_REDIS_PORT:-6379}:6379'
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 64M
    logging: *default-logging
    volumes:
      - kgc-redis-data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - kgc-network

  # --------------------------------------------------------------------------
  # KGC MinIO (S3-compatible Object Storage)
  # --------------------------------------------------------------------------
  kgc-minio:
    image: minio/minio:latest
    container_name: kgc-minio
    ports:
      - '${MINIO_API_PORT:-9000}:9000'
      - '${MINIO_CONSOLE_PORT:-9001}:9001'
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
    logging: *default-logging
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
    volumes:
      - kgc-minio-data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - kgc-network

  # ============================================================================
  # TWENTY CRM (Customer Relationship Management)
  # ============================================================================

  twenty-server:
    image: twentycrm/twenty:latest
    container_name: kgc-twenty-server
    ports:
      - '${TWENTY_PORT:-3001}:3000'
    depends_on:
      twenty-db:
        condition: service_healthy
      twenty-redis:
        condition: service_started
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
    logging: *default-logging
    environment:
      PG_DATABASE_URL: postgres://${TWENTY_DB_USER:-twenty}:${TWENTY_DB_PASSWORD}@twenty-db:5432/${TWENTY_DB_NAME:-twenty}
      REDIS_URL: redis://twenty-redis:6379
      SERVER_URL: ${TWENTY_SERVER_URL:-http://localhost:3001}
      FRONT_BASE_URL: ${TWENTY_FRONT_URL:-http://localhost:3001}
      STORAGE_TYPE: local
      STORAGE_LOCAL_PATH: /app/.local-storage
      APP_SECRET: ${TWENTY_APP_SECRET:?TWENTY_APP_SECRET is required}
      ACCESS_TOKEN_SECRET: ${TWENTY_APP_SECRET}
      LOGIN_TOKEN_SECRET: ${TWENTY_APP_SECRET}
      REFRESH_TOKEN_SECRET: ${TWENTY_APP_SECRET}
      FILE_TOKEN_SECRET: ${TWENTY_APP_SECRET}
    volumes:
      - twenty-server-data:/app/.local-storage
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/healthz']
      <<: *healthcheck-app
    restart: unless-stopped
    networks:
      - kgc-network

  twenty-worker:
    image: twentycrm/twenty:latest
    container_name: kgc-twenty-worker
    command: ['yarn', 'worker:prod']
    depends_on:
      twenty-server:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
    logging: *default-logging
    environment:
      PG_DATABASE_URL: postgres://${TWENTY_DB_USER:-twenty}:${TWENTY_DB_PASSWORD}@twenty-db:5432/${TWENTY_DB_NAME:-twenty}
      REDIS_URL: redis://twenty-redis:6379
      SERVER_URL: ${TWENTY_SERVER_URL:-http://localhost:3001}
      APP_SECRET: ${TWENTY_APP_SECRET}
      ACCESS_TOKEN_SECRET: ${TWENTY_APP_SECRET}
      LOGIN_TOKEN_SECRET: ${TWENTY_APP_SECRET}
      REFRESH_TOKEN_SECRET: ${TWENTY_APP_SECRET}
      FILE_TOKEN_SECRET: ${TWENTY_APP_SECRET}
    restart: unless-stopped
    networks:
      - kgc-network

  twenty-db:
    image: postgres:16-alpine
    container_name: kgc-twenty-db
    ports:
      - '${TWENTY_DB_PORT:-5433}:5432'
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
    logging: *default-logging
    environment:
      POSTGRES_USER: ${TWENTY_DB_USER:-twenty}
      POSTGRES_PASSWORD: ${TWENTY_DB_PASSWORD:?TWENTY_DB_PASSWORD is required}
      POSTGRES_DB: ${TWENTY_DB_NAME:-twenty}
    volumes:
      - twenty-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${TWENTY_DB_USER:-twenty} -d ${TWENTY_DB_NAME:-twenty}']
      <<: *healthcheck-db
    restart: unless-stopped
    networks:
      - kgc-network

  twenty-redis:
    image: redis:7-alpine
    container_name: kgc-twenty-redis
    command: redis-server --maxmemory 256mb --maxmemory-policy noeviction
    ports:
      - '${TWENTY_REDIS_PORT:-6380}:6379'
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 64M
    logging: *default-logging
    volumes:
      - twenty-redis-data:/data
    restart: unless-stopped
    networks:
      - kgc-network

  # ============================================================================
  # CHATWOOT (Customer Support Platform)
  # ============================================================================

  chatwoot-rails:
    image: chatwoot/chatwoot:${CHATWOOT_VERSION:-latest-ce}
    container_name: kgc-chatwoot-rails
    ports:
      - '${CHATWOOT_PORT:-3002}:3000'
    depends_on:
      chatwoot-db:
        condition: service_healthy
      chatwoot-redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
    logging: *default-logging
    environment:
      NODE_ENV: production
      RAILS_ENV: production
      INSTALLATION_ENV: docker
      SECRET_KEY_BASE: ${CHATWOOT_SECRET_KEY:?CHATWOOT_SECRET_KEY is required}
      FRONTEND_URL: ${CHATWOOT_FRONTEND_URL:-http://localhost:3002}
      POSTGRES_HOST: chatwoot-db
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: ${CHATWOOT_DB_NAME:-chatwoot_production}
      POSTGRES_USERNAME: ${CHATWOOT_DB_USER:-chatwoot}
      POSTGRES_PASSWORD: ${CHATWOOT_DB_PASSWORD}
      REDIS_URL: redis://:${CHATWOOT_REDIS_PASSWORD}@chatwoot-redis:6379
      RAILS_LOG_TO_STDOUT: 'true'
    volumes:
      - chatwoot-storage:/app/storage
    entrypoint: docker/entrypoints/rails.sh
    command: ['bundle', 'exec', 'rails', 's', '-p', '3000', '-b', '0.0.0.0']
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3000/api']
      <<: *healthcheck-app
      start_period: 120s
    restart: unless-stopped
    networks:
      - kgc-network

  chatwoot-sidekiq:
    image: chatwoot/chatwoot:${CHATWOOT_VERSION:-latest-ce}
    container_name: kgc-chatwoot-sidekiq
    depends_on:
      chatwoot-rails:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
    logging: *default-logging
    environment:
      NODE_ENV: production
      RAILS_ENV: production
      INSTALLATION_ENV: docker
      SECRET_KEY_BASE: ${CHATWOOT_SECRET_KEY}
      POSTGRES_HOST: chatwoot-db
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: ${CHATWOOT_DB_NAME:-chatwoot_production}
      POSTGRES_USERNAME: ${CHATWOOT_DB_USER:-chatwoot}
      POSTGRES_PASSWORD: ${CHATWOOT_DB_PASSWORD}
      REDIS_URL: redis://:${CHATWOOT_REDIS_PASSWORD}@chatwoot-redis:6379
    volumes:
      - chatwoot-storage:/app/storage
    command: ['bundle', 'exec', 'sidekiq', '-C', 'config/sidekiq.yml']
    restart: unless-stopped
    networks:
      - kgc-network

  chatwoot-db:
    image: pgvector/pgvector:pg16
    container_name: kgc-chatwoot-db
    ports:
      - '${CHATWOOT_DB_PORT:-5435}:5432'
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
    logging: *default-logging
    environment:
      POSTGRES_USER: ${CHATWOOT_DB_USER:-chatwoot}
      POSTGRES_PASSWORD: ${CHATWOOT_DB_PASSWORD:?CHATWOOT_DB_PASSWORD is required}
      POSTGRES_DB: ${CHATWOOT_DB_NAME:-chatwoot_production}
    volumes:
      - chatwoot-db-data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'pg_isready -U ${CHATWOOT_DB_USER:-chatwoot} -d ${CHATWOOT_DB_NAME:-chatwoot_production}',
        ]
      <<: *healthcheck-db
    restart: unless-stopped
    networks:
      - kgc-network

  chatwoot-redis:
    image: redis:7-alpine
    container_name: kgc-chatwoot-redis
    command: redis-server --requirepass ${CHATWOOT_REDIS_PASSWORD:?CHATWOOT_REDIS_PASSWORD is required} --maxmemory 512mb --maxmemory-policy allkeys-lru --appendonly yes
    ports:
      - '${CHATWOOT_REDIS_PORT:-6381}:6379'
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 64M
    logging: *default-logging
    volumes:
      - chatwoot-redis-data:/data
    healthcheck:
      test: ['CMD-SHELL', 'redis-cli -a ${CHATWOOT_REDIS_PASSWORD} ping | grep -q PONG']
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - kgc-network

  # ============================================================================
  # HORILLA HR (Human Resources Management)
  # ============================================================================

  horilla-app:
    image: horilla/horilla:1.4
    container_name: kgc-horilla-app
    ports:
      - '${HORILLA_PORT:-3003}:8000'
    depends_on:
      horilla-db:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
    logging: *default-logging
    environment:
      DJANGO_SECRET_KEY: ${HORILLA_SECRET_KEY:?HORILLA_SECRET_KEY is required}
      DJANGO_DEBUG: ${HORILLA_DEBUG:-False}
      DJANGO_ALLOWED_HOSTS: ${HORILLA_ALLOWED_HOSTS:-localhost,127.0.0.1,horilla-app}
      DATABASE_URL: postgres://${HORILLA_DB_USER:-horilla}:${HORILLA_DB_PASSWORD}@horilla-db:5432/${HORILLA_DB_NAME:-horilla}
      DB_HOST: horilla-db
      DB_PORT: 5432
      DB_NAME: ${HORILLA_DB_NAME:-horilla}
      DB_USER: ${HORILLA_DB_USER:-horilla}
      DB_PASSWORD: ${HORILLA_DB_PASSWORD}
      SITE_URL: ${HORILLA_SITE_URL:-http://localhost:3003}
      CSRF_TRUSTED_ORIGINS: ${HORILLA_CSRF_ORIGINS:-http://localhost:3003,http://127.0.0.1:3003}
    volumes:
      - horilla-static:/app/staticfiles
      - horilla-media:/app/media
    healthcheck:
      test:
        ['CMD', 'curl', '-fL', '-o', '/dev/null', '-w', '%{http_code}', 'http://localhost:8000/']
      <<: *healthcheck-app
      start_period: 120s
    restart: unless-stopped
    networks:
      - kgc-network

  horilla-db:
    image: postgres:16-alpine
    container_name: kgc-horilla-db
    ports:
      - '${HORILLA_DB_PORT:-5434}:5432'
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
    logging: *default-logging
    environment:
      POSTGRES_USER: ${HORILLA_DB_USER:-horilla}
      POSTGRES_PASSWORD: ${HORILLA_DB_PASSWORD:?HORILLA_DB_PASSWORD is required}
      POSTGRES_DB: ${HORILLA_DB_NAME:-horilla}
    volumes:
      - horilla-db-data:/var/lib/postgresql/data
    healthcheck:
      test:
        ['CMD-SHELL', 'pg_isready -U ${HORILLA_DB_USER:-horilla} -d ${HORILLA_DB_NAME:-horilla}']
      <<: *healthcheck-db
    restart: unless-stopped
    networks:
      - kgc-network

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  # KGC Core
  kgc-db-data:
    name: kgc-db-data
  kgc-redis-data:
    name: kgc-redis-data
  kgc-minio-data:
    name: kgc-minio-data

  # Twenty CRM
  twenty-db-data:
    name: kgc-twenty-db-data
  twenty-server-data:
    name: kgc-twenty-server-data
  twenty-redis-data:
    name: kgc-twenty-redis-data

  # Chatwoot
  chatwoot-db-data:
    name: kgc-chatwoot-db-data
  chatwoot-redis-data:
    name: kgc-chatwoot-redis-data
  chatwoot-storage:
    name: kgc-chatwoot-storage

  # Horilla HR
  horilla-db-data:
    name: kgc-horilla-db-data
  horilla-static:
    name: kgc-horilla-static
  horilla-media:
    name: kgc-horilla-media

# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  kgc-network:
    name: kgc-network
    driver: bridge
