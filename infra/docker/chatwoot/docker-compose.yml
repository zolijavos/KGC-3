# ==============================================================================
# Chatwoot - Docker Compose Configuration
# KGC ERP Integration - Story 33-2
# ==============================================================================
# Chatwoot: Open-source customer engagement platform
# Port: 3002 (to avoid conflict with KGC API on 3000, Twenty on 3001)
# DB Port: 5435 (separate from KGC:5432, Twenty:5433, Horilla:5434)
# Redis Port: 6381 (separate from KGC:6379, Twenty:6380)
# ==============================================================================

name: kgc-chatwoot

x-base: &base
  image: chatwoot/chatwoot:${CHATWOOT_VERSION:-latest-ce}
  env_file: .env
  volumes:
    - chatwoot-storage:/app/storage
  networks:
    - kgc-network
  depends_on:
    chatwoot-db:
      condition: service_healthy
    chatwoot-redis:
      condition: service_healthy
  restart: unless-stopped

services:
  # =============================================================================
  # Chatwoot Rails Application
  # =============================================================================
  chatwoot-rails:
    <<: *base
    container_name: kgc-chatwoot-rails
    ports:
      - "${CHATWOOT_PORT:-3002}:3000"
    environment:
      NODE_ENV: production
      RAILS_ENV: production
      INSTALLATION_ENV: docker
    entrypoint: docker/entrypoints/rails.sh
    command: ['bundle', 'exec', 'rails', 's', '-p', '3000', '-b', '0.0.0.0']
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # =============================================================================
  # Chatwoot Sidekiq Worker (Background Jobs)
  # =============================================================================
  chatwoot-sidekiq:
    <<: *base
    container_name: kgc-chatwoot-sidekiq
    command: ['bundle', 'exec', 'sidekiq', '-C', 'config/sidekiq.yml']
    environment:
      NODE_ENV: production
      RAILS_ENV: production
      INSTALLATION_ENV: docker
    healthcheck:
      test: ["CMD-SHELL", "bundle exec sidekiqmon processes | grep -q 'RUNNING'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # =============================================================================
  # PostgreSQL Database (with pgvector)
  # =============================================================================
  chatwoot-db:
    image: pgvector/pgvector:${POSTGRES_VERSION:-pg16}
    container_name: kgc-chatwoot-db
    ports:
      - "${CHATWOOT_DB_PORT:-5435}:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-chatwoot}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-chatwoot}
      POSTGRES_DB: ${POSTGRES_DB:-chatwoot_production}
    volumes:
      - chatwoot-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-chatwoot} -d ${POSTGRES_DB:-chatwoot_production}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - kgc-network

  # =============================================================================
  # Redis Cache & Queue
  # =============================================================================
  chatwoot-redis:
    image: redis:${REDIS_VERSION:-7-alpine}
    container_name: kgc-chatwoot-redis
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-chatwoot_redis_pass}
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
    ports:
      - "${CHATWOOT_REDIS_PORT:-6381}:6379"
    volumes:
      - chatwoot-redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-chatwoot_redis_pass}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - kgc-network

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  chatwoot-db-data:
    name: kgc-chatwoot-db-data
  chatwoot-redis-data:
    name: kgc-chatwoot-redis-data
  chatwoot-storage:
    name: kgc-chatwoot-storage

# ==============================================================================
# Networks
# ==============================================================================
networks:
  kgc-network:
    name: kgc-network
    external: true
