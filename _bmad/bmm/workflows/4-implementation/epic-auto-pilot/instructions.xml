<?xml version="1.0" encoding="UTF-8"?>
<!--
  Epic Auto-Pilot Workflow Instructions
  Teljesen automatiz√°lt epic fejleszt√©s user j√≥v√°hagy√°s n√©lk√ºl
-->
<workflow-instructions>
  <metadata>
    <id>epic-auto-pilot</id>
    <version>1.0.0</version>
    <language>Hungarian</language>
  </metadata>

  <!-- ============================================ -->
  <!-- STEP 1: INICIALIZ√ÅL√ÅS                        -->
  <!-- ============================================ -->
  <step id="initialize">
    <name>Epic Inicializ√°l√°s</name>
    <instructions>
      <![CDATA[
## 1. Bet√∂ltend≈ë f√°jlok

Olvasd be a k√∂vetkez≈ë f√°jlokat:

1. **Sprint Status**: `implementation-artifacts/sprint-status.yaml`
   - Azonos√≠tsd az epic-{epic_number} √∂sszes story-j√°t
   - Jegyezd fel a backlog √©s drafted st√°tusz√∫akat

2. **Epic File**: `planning-artifacts/epics/epic-{epic_number}.md` (ha l√©tezik)
   - Epic kontextus √©s scope meg√©rt√©s√©hez

3. **Development Principles**: `docs/kgc3-development-principles.md`
   - TDD/ATDD szab√°lyok betart√°s√°hoz

## 2. Backlog Story-k azonos√≠t√°sa

A sprint-status.yaml-b≈ël gy≈±jtsd ki az √∂sszes story-t ahol:
- Story ID: `{epic_number}-*` pattern
- Status: `backlog` VAGY `drafted`

K√©sz√≠ts egy list√°t feldolgoz√°si sorrendben (sz√°moz√°s szerint).

## 3. Package azonos√≠t√°s

Epic alapj√°n hat√°rozd meg a target package-et:
- Epic 1: @kgc/auth
- Epic 2: @kgc/users
- Epic 3: @kgc/tenant
- Epic 4: @kgc/config
- Epic 5: @kgc/ui
- Epic 6: @kgc/audit
- stb.

## 4. √Ållapot inicializ√°l√°s

```
processed_stories: []
skipped_stories: []
current_retry_count: 0
epic_complete: false
```

FOLYTASD a story_loop l√©p√©ssel ha van backlog story.
HA NINCS backlog story ‚Üí ugorj epic_complete l√©p√©sre.
      ]]>
    </instructions>
  </step>

  <!-- ============================================ -->
  <!-- STEP 2: STORY FELDOLGOZ√ÅSI HUROK             -->
  <!-- ============================================ -->
  <step id="story_loop">
    <name>Story Feldolgoz√°si Hurok</name>
    <loop condition="hasBacklogStories">
    <instructions>
      <![CDATA[
## Story Loop - Automatikus feldolgoz√°s

MINDEN backlog/drafted story-ra ism√©teld:

### 2.1 K√∂vetkez≈ë story kiv√°laszt√°sa

V√°laszd ki a k√∂vetkez≈ë feldolgozatlan story-t sz√°moz√°s szerint.
Pl: 5-2, 5-3, 5-4... sorrendben.

### 2.2 Story st√°tusz ellen≈ërz√©s

- Ha `backlog` ‚Üí create_story substep
- Ha `drafted` ‚Üí create_story substep (ready-for-dev-v√© kell tenni)
- Ha `ready-for-dev` vagy `in-progress` ‚Üí dev_story substep
- Ha `review` ‚Üí code_review substep
- Ha `done` ‚Üí skip, k√∂vetkez≈ë story

### 2.3 Retry logika

Ha b√°rmely substep SIKERTELEN:
1. N√∂veld: current_retry_count++
2. Ha current_retry_count < max_retries ‚Üí pr√≥b√°ld √∫jra
3. Ha current_retry_count >= max_retries:
   - Logold a hib√°t
   - Add hozz√°: skipped_stories.push(story_id)
   - Ha skipped_stories.length > 2 ‚Üí √ÅLLJ LE hib√°val
   - K√ºl√∂nben: current_retry_count = 0, k√∂vetkez≈ë story

### 2.4 Sikeres befejez√©s

Ha a story DONE st√°tusz√∫ lett:
1. Add hozz√°: processed_stories.push(story_id)
2. current_retry_count = 0
3. K√∂vetkez≈ë story VAGY epic_complete ha nincs t√∂bb
      ]]>
    </instructions>
    </loop>
  </step>

  <!-- ============================================ -->
  <!-- SUBSTEP 2A: STORY L√âTREHOZ√ÅS                 -->
  <!-- ============================================ -->
  <substep id="create_story" parent="story_loop">
    <name>Story L√©trehoz√°s</name>
    <instructions>
      <![CDATA[
## Story l√©trehoz√°s (backlog ‚Üí ready-for-dev)

### Automatikus story file gener√°l√°s

1. **Olvasd be az epic f√°jlt** a story defin√≠ci√≥√©rt
2. **Gener√°ld a story f√°jlt**:
   - Path: `implementation-artifacts/stories/{story_id}.md`
   - Haszn√°ld a story template-et
   - T√∂ltsd ki: user story, acceptance criteria, tasks

3. **Sprint status friss√≠t√©s**:
   ```yaml
   {story_id}: ready-for-dev
   ```

4. **NE K√âRDEZZ** - automatikusan folytasd

### Story file minimum tartalma

```markdown
# Story {story_id}: {title}

## Status: ready-for-dev

## User Story
As a [role]...

## Acceptance Criteria
- [ ] AC1...
- [ ] AC2...

## Tasks
1. Task 1
2. Task 2

## Technical Notes
- Package: @kgc/{package}
- Dependencies: ...
```

SIKER ‚Üí folytasd dev_story substep-pel
HIBA ‚Üí retry logika
      ]]>
    </instructions>
  </substep>

  <!-- ============================================ -->
  <!-- SUBSTEP 2B: STORY IMPLEMENT√ÅL√ÅS              -->
  <!-- ============================================ -->
  <substep id="dev_story" parent="story_loop">
    <name>Story Implement√°l√°s</name>
    <instructions>
      <![CDATA[
## Story fejleszt√©s (ready-for-dev ‚Üí review)

### TDD Folyamat (K√ñTELEZ≈ê)

1. **Sprint status friss√≠t√©s**:
   ```yaml
   {story_id}: in-progress
   ```

2. **Tesztek EL≈êSZ√ñR** (Red phase):
   - √çrj FAILING teszteket az acceptance criteria alapj√°n
   - F√°jlok: `packages/{layer}/{package}/tests/*.spec.ts`

3. **Implement√°ci√≥** (Green phase):
   - √çrd meg a k√≥dot ami √ÅTMEGY a teszteken
   - Csak annyi k√≥d ami kell a tesztekhez

4. **Refactor** (ha sz√ºks√©ges):
   - Clean code elvek
   - DRY, SOLID

5. **Tesztek futtat√°sa**:
   ```bash
   pnpm test --filter @kgc/{package}
   ```

6. **Ha MINDEN teszt Z√ñLD**:
   - Sprint status: `{story_id}: review`
   - Folytasd code_review substep-pel

### Automatikus hibajav√≠t√°s

Ha a tesztek FAILELNEK:
1. Olvasd el a hiba√ºzenetet
2. Jav√≠tsd a k√≥dot
3. Futtasd √∫jra a teszteket
4. Max {max_retries} pr√≥b√°lkoz√°s

NE K√âRDEZZ - automatikusan jav√≠ts √©s pr√≥b√°ld √∫jra.

SIKER (tesztek z√∂ldek) ‚Üí code_review substep
HIBA (max retry ut√°n) ‚Üí retry logika
      ]]>
    </instructions>
  </substep>

  <!-- ============================================ -->
  <!-- SUBSTEP 2C: CODE REVIEW                      -->
  <!-- ============================================ -->
  <substep id="code_review" parent="story_loop">
    <name>Code Review</name>
    <instructions>
      <![CDATA[
## Adversarial Code Review (review ‚Üí done)

### Review v√©grehajt√°s (CLAUDE ONLY - nincs Gemini)

1. **Review f√°jlok azonos√≠t√°sa**:
   - Minden m√≥dos√≠tott/√∫j f√°jl a story-ban
   - Package: `packages/{layer}/{package}/src/**`

2. **Adversarial review krit√©riumok**:
   - Minimum 3 issue keres√©se (BMAD szab√°ly)
   - Kateg√≥ri√°k: CRITICAL, MEDIUM, MINOR

3. **Review strictness: {review_strictness}**:
   - `critical_only`: Csak CRITICAL issue-kat jav√≠tsd
   - `critical_medium`: CRITICAL + MEDIUM
   - `all`: MINDEN issue-t jav√≠ts (CRITICAL + MEDIUM + MINOR)

### Ellen≈ërz√©si pontok

- [ ] TypeScript strict compliance
- [ ] Tesztek megfelel≈ë coverage-gel
- [ ] Nincs hardcoded √©rt√©k
- [ ] Error handling megfelel≈ë
- [ ] Acceptance criteria teljes√ºl
- [ ] Development principles betartva
- [ ] Nincs security vulnerability

### Automatikus jav√≠t√°s

MINDEN tal√°lt issue-ra ({review_strictness} szerint):

1. Azonos√≠tsd a probl√©m√°t
2. √çrd meg a fix-et
3. Alkalmazd az Edit tool-lal
4. Futtasd √∫jra a teszteket

### Nincs user j√≥v√°hagy√°s

- NE K√âRDEZZ j√≥v√°hagy√°st
- Automatikusan jav√≠ts MINDENT
- Ha nem tudod jav√≠tani ‚Üí logold √©s folytasd

### Review dokument√°l√°s

K√©sz√≠ts review f√°jlt (opcion√°lis):
`implementation-artifacts/reviews/epic-{epic_number}/{story_id}-review.md`

SIKER (minden jav√≠tva, tesztek z√∂ldek) ‚Üí verify_coverage substep
HIBA ‚Üí retry logika
      ]]>
    </instructions>
  </substep>

  <!-- ============================================ -->
  <!-- SUBSTEP 2D: COVERAGE ELLEN≈êRZ√âS              -->
  <!-- ============================================ -->
  <substep id="verify_coverage" parent="story_loop">
    <name>Coverage Ellen≈ërz√©s</name>
    <instructions>
      <![CDATA[
## Coverage ellen≈ërz√©s

### Coverage report futtat√°s

```bash
pnpm test:coverage --filter @kgc/{package}
```

### Threshold ellen≈ërz√©s

- Coverage threshold: {coverage_threshold}%
- Ha coverage >= threshold ‚Üí OK
- Ha coverage < threshold ‚Üí WARN de FOLYTAT√ìDIK

### Figyelmeztet√©s logol√°sa

Ha coverage alatt van:
```
‚ö†Ô∏è WARNING: Coverage {actual}% < {threshold}%
   Story: {story_id}
   Package: @kgc/{package}
   Continuing anyway per configuration...
```

NE √ÅLLJ LE coverage warning miatt - csak logold.

MINDIG FOLYTASD ‚Üí mark_done substep
      ]]>
    </instructions>
  </substep>

  <!-- ============================================ -->
  <!-- SUBSTEP 2E: STORY LEZ√ÅR√ÅS                    -->
  <!-- ============================================ -->
  <substep id="mark_done" parent="story_loop">
    <name>Story Lez√°r√°s</name>
    <instructions>
      <![CDATA[
## Story lez√°r√°s (‚Üí done)

### Sprint status friss√≠t√©s

```yaml
{story_id}: done
```

### Story file friss√≠t√©s

A story markdown f√°jlban:
- Status: done
- Completion date
- Test count √©s coverage

### Processed lista friss√≠t√©s

```
processed_stories.push(story_id)
current_retry_count = 0
```

### K√∂vetkez≈ë l√©p√©s

- Ha van m√©g backlog story ‚Üí vissza story_loop elej√©re
- Ha NINCS t√∂bb backlog story ‚Üí epic_complete step

AUTOMATIKUSAN FOLYTASD a k√∂vetkez≈ë story-val vagy epic lez√°r√°ssal.
      ]]>
    </instructions>
  </substep>

  <!-- ============================================ -->
  <!-- STEP 3: EPIC LEZ√ÅR√ÅS                         -->
  <!-- ============================================ -->
  <step id="epic_complete">
    <name>Epic Lez√°r√°s</name>
    <instructions>
      <![CDATA[
## Epic lez√°r√°s √©s √∂sszefoglal√≥

### Sprint status friss√≠t√©s

```yaml
epic-{epic_number}: done
```

### √ñsszefoglal√≥ gener√°l√°s

√çrd ki a k√∂vetkez≈ëket:

```
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  EPIC {epic_number} COMPLETE ‚úÖ
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìä Statisztik√°k:
   - Feldolgozott story-k: {processed_stories.length}
   - Kihagyott story-k: {skipped_stories.length}

üìù Feldolgozott:
{processed_stories.map(s => `   ‚úÖ ${s}`).join('\n')}

‚ö†Ô∏è Kihagyott (ha van):
{skipped_stories.map(s => `   ‚ùå ${s}`).join('\n')}

üéØ K√∂vetkez≈ë l√©p√©sek:
   - Retrospective futtat√°sa aj√°nlott
   - K√∂vetkez≈ë epic ind√≠t√°sa

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
```

### WORKFLOW V√âGE

Az epic-auto-pilot BEFEJEZ≈êD√ñTT.
      ]]>
    </instructions>
  </step>

  <!-- ============================================ -->
  <!-- ERROR HANDLING                               -->
  <!-- ============================================ -->
  <error-handling>
    <policy name="story_failure">
      <description>Ha egy story feldolgoz√°sa sikertelen max retry ut√°n</description>
      <action>
        1. Logold a hib√°t r√©szletesen
        2. Add hozz√° skipped_stories list√°hoz
        3. Ha skipped_stories.length > 2 ‚Üí CRITICAL STOP
        4. K√ºl√∂nben folytasd a k√∂vetkez≈ë story-val
      </action>
    </policy>

    <policy name="test_failure">
      <description>Ha a tesztek failelnek</description>
      <action>
        1. Olvasd el a hiba√ºzenetet
        2. Automatikusan jav√≠tsd a k√≥dot
        3. Pr√≥b√°ld √∫jra (max {max_retries})
        4. Ha max retry ut√°n is fail ‚Üí story_failure policy
      </action>
    </policy>

    <policy name="critical_stop">
      <description>Kritikus hiba - workflow le√°ll√≠t√°s</description>
      <triggers>
        - T√∂bb mint 2 story kihagyva
        - Nem olvashat√≥/√≠rhat√≥ f√°jl
        - Package nem tal√°lhat√≥
      </triggers>
      <action>
        √ÅLLJ LE √©s √≠rd ki a hib√°t a usernek.
      </action>
    </policy>
  </error-handling>

  <!-- ============================================ -->
  <!-- CONFIGURATION DEFAULTS                       -->
  <!-- ============================================ -->
  <defaults>
    <param name="max_retries" value="3" />
    <param name="review_strictness" value="all" />
    <param name="coverage_threshold" value="80" />
    <param name="skip_on_failure" value="true" />
  </defaults>

</workflow-instructions>
